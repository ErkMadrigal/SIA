<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reconocimiento Facial con Luxand API</title>
<style>
  body { 
    font-family: Arial; 
    padding:20px; 
    background:#f0f0f0; 
  }
  h1 { font-size:1.5rem; text-align: center; }
  h2 { text-align: center; }

  .container { 
    display:flex; 
    gap:30px; 
    justify-content: center;
  }

  .cam {
    position: relative;
    width: 350px;
    height: 260px;
  }

  .cam video, 
  .cam canvas {
    position:absolute;
    top:0;
    left:0;
    width:350px;
    height:260px;
    border-radius:8px;
  }

  .controls { 
    display:flex; 
    flex-direction:column; 
    gap:10px; 
    margin-top: 15px;
  }

  input { 
    padding:6px; 
    border-radius:6px; 
    border:1px solid #ccc; 
  }

  button { 
    padding:8px 16px; 
    border-radius:6px; 
    border:none; 
    cursor:pointer; 
    background:#2563eb; 
    color:white; 
    font-size: 15px;
  }

  button.secondary { background:#6b7280; }

  #resultado { 
    font-weight:bold; 
    margin-top:10px; 
    font-size:1.2rem; 
  }
</style>
</head>
<body>

<h1>Reconocimiento Facial (Registro / Lectura)</h1>

<div class="container">

  <!-- Registro -->
  <div>
    <h2>Registrar rostro</h2>

    <div class="cam">
      <video id="videoReg" autoplay muted></video>
      <canvas id="canvasReg"></canvas>
    </div>

    <div class="controls">
      <input type="text" id="nombre" placeholder="Nombre">
      <button id="btnRegistrar">Registrar</button>
      <button id="btnBorrar" class="secondary">Borrar Base</button>
      <p id="lista">Plantillas guardadas: (ninguna)</p>
    </div>
  </div>

  <!-- Lectura -->
  <div>
    <h2>Reconocer rostro</h2>

    <div class="cam">
      <video id="videoRead" autoplay muted></video>
      <canvas id="canvasRead"></canvas>
    </div>

    <div class="controls">
      <button id="btnLeer">Leer rostro</button>
      <p id="resultado">Resultado: -</p>
    </div>
  </div>

</div>

<script>
const API_TOKEN = "1634a415a6104185a7b3a52fa5701862";
// const API_TOKEN = "a5da54250240419999df7a0dfa36cd3d"; //smontejo

// -----------------------------
// Cámara
// -----------------------------
async function iniciarCamara(videoEl){
  const stream = await navigator.mediaDevices.getUserMedia({ video:true });
  videoEl.srcObject = stream;
  return new Promise(resolve => videoEl.onloadedmetadata = resolve);
}

// -----------------------------
// Base local
// -----------------------------
function getDB(){ return JSON.parse(localStorage.getItem("faceDB")||"[]"); }
function saveDB(db){ localStorage.setItem("faceDB", JSON.stringify(db)); renderList(); }
function renderList(){
  const db = getDB();
  const lista = document.getElementById("lista");
  lista.innerText = db.length 
    ? "Plantillas guardadas:\n"+db.map(x=>`• ${x.nombre}`).join("\n") 
    : "Plantillas guardadas: (ninguna)";
}

// -----------------------------
// Captura frame como Blob
// -----------------------------
function capturaFrame(video){
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth || 350;
  canvas.height = video.videoHeight || 260;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  return new Promise(resolve => canvas.toBlob(resolve,"image/jpeg"));
}

// -----------------------------
// Luxand API similarity
// -----------------------------
function similarity(face1, face2, callback){
  const myHeaders = new Headers();
  myHeaders.append("token", API_TOKEN);
  const formdata = new FormData();
  formdata.append("face1", face1, "file");
  formdata.append("face2", face2, "file");

  fetch("https://api.luxand.cloud/photo/similarity", {
    method:'POST',
    headers: myHeaders,
    body: formdata
  })
  .then(resp => resp.json())
  .then(res => callback(res))
  .catch(err => console.error(err));
}

// -----------------------------
// base64 → Blob
// -----------------------------
function dataURLtoBlob(dataurl){
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--) u8arr[n]=bstr.charCodeAt(n);
  return new Blob([u8arr],{type:mime});
}

// -----------------------------
// Dibujar bounding box
// -----------------------------
function dibujarBox(canvas){
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = "red";
  ctx.lineWidth = 4;
  ctx.strokeRect(10,10,canvas.width-20,canvas.height-20);
}

// -----------------------------
// Registrar rostro
// -----------------------------
document.getElementById("btnRegistrar").addEventListener("click", async ()=>{
  const nombre = document.getElementById("nombre").value.trim();
  if(!nombre){ alert("Escribe un nombre"); return; }

  const video = document.getElementById("videoReg");
  const canvas = document.getElementById("canvasReg");
  dibujarBox(canvas);

  const blob = await capturaFrame(video);
  const reader = new FileReader();

  reader.onloadend = ()=>{
    const base64 = reader.result;
    const db = getDB();
    db.push({ nombre, image: base64 });
    saveDB(db);
    alert("Rostro registrado correctamente");
  };

  reader.readAsDataURL(blob);
});

// -----------------------------
// Leer rostro
// -----------------------------
document.getElementById("btnLeer").addEventListener("click", async ()=>{
  const video = document.getElementById("videoRead");
  const canvas = document.getElementById("canvasRead");
  dibujarBox(canvas);

  const blob = await capturaFrame(video);
  const reader = new FileReader();

  reader.onloadend = async ()=>{
    const base64 = reader.result;
    const db = getDB();

    if(!db.length){ 
      document.getElementById("resultado").innerText="Resultado: No hay plantillas"; 
      return; 
    }

    let mejor = { nombre:"-", score:0 };

    for(const item of db){
      await new Promise(resolve=>{
        similarity(dataURLtoBlob(base64), dataURLtoBlob(item.image), (res)=>{
          if(res.score > mejor.score){
            mejor = { nombre:item.nombre, score:res.score };
          }
          resolve();
        });
      });
    }

    document.getElementById("resultado").innerText = 
      `Resultado: ${mejor.nombre} (similitud: ${mejor.score.toFixed(4)})`;
  };

  reader.readAsDataURL(blob);
});

// -----------------------------
// Borrar base
// -----------------------------
document.getElementById("btnBorrar").addEventListener("click", ()=>{
  localStorage.removeItem("faceDB");
  renderList();
  alert("Base borrada");
});

// -----------------------------
// Inicializar cámaras
// -----------------------------
window.addEventListener("DOMContentLoaded", async ()=>{
  await iniciarCamara(document.getElementById("videoReg"));
  await iniciarCamara(document.getElementById("videoRead"));
  renderList();
});
</script>

</body>
</html>
